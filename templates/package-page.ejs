<%- include('header.ejs', locals) %>

<div id="package">
  <h1><%= package.name %></h1>

  <% if (package.description) { %>
    <p class="description"><%= package.description %></p>
  <% } %>

  <pre class="sh"><code>npm install <%= package.name %></code></pre>

  <table class="metadata">
    <% if (package.maintainers) { %>
    <tr>
      <th>Maintainers:</th>
      <td>
      <%
      package.maintainers.forEach(function (m) {
        %>
        <div class="user">
        <a class="username" href="/profile/<%= m.name %>"><%
          if (m.avatar) {
          %><img src="<%= m.avatar %>" class="avatar">
          <% } %><%= m.name %></a>
        </div>
        <%
      })
      %>
      </td>
    </tr>
    <% } %>
    <tr>
      <th>Version:</th>
      <td>
        <b>
        <%= package.version %>
        </b>
        <% if (package.fromNow) { %>
        last updated
        <%= package.fromNow %>
        <% } %>
      </td>
    </tr>
    <%
    if (typeof package.keywords === 'string') {
      package.keywords = package.keywords.split(/\s*,?\s*/)
    }
    if (Array.isArray(package.keywords)) {
    %>
    <tr>
      <th>Keywords:</th>
      <td><%-
        package.keywords.map(function (kw) {
          kw = kw.replace(/</g, '&lt;').replace(/"/g, '&quot;')
          return '<a href="/browse/keyword/' + kw + '">' + kw + '</a>'
        }).join(', ')
        %></td>
    </tr>
    <% } %>
    <% if (package.repository && package.repository !== 'undefined') {
    var gh = package.repository.url &&
        package.repository.url.match(
        /^(?:https?:\/\/|git(?::\/\/|@))github.com[:\/](.*?)(?:.git)?$/)
    if (gh) {
      gh = 'https://github.com/' + gh[1]
    }
    %>
    <tr>
      <th>Repository:</td>
      <td>
        <% if (gh) { %><a id="github" href="<%= gh %>"><% } %>
        <%= package.repository.url %><% if (gh) { %></a><% } %>
        (<%= package.repository.type %>)
      </td>
      <% } %>
      <% if (package.bugs && package.bugs.url) { %>
      <tr>
        <th>Bugs:</td>
        <td>
          <a href="<%= package.bugs.url %>"><%= package.bugs.url %></a>
        </td>
        <% } %>
        <tr>
          <th>Dependencies:</th>
          <td>
            <%-
            Object.keys(package.dependencies || {}).map(function(pkg) {
            return '<a href="/package/' + pkg + '">' + pkg + '</a>'
            }).join(', ') || 'None'
            %>
          </td>
        </tr>
        <%
        var dependents = package.dependents
        if (dependents && dependents.length) { %>
        <tr>
          <th>Dependents:</th>
          <td>
          <%
          var l = dependents.length
          var max = 20
          if (l > max) {
            // get a random assortment each time.
            var dependents = dependents.sort(function (a, b) {
              return Math.random() * 2 - 1
            }).slice(0, max)
            dependents.push({
              url: '/browse/depended/' + package.name,
              name: '<br>and ' + (l-max) + ' more'
            })
          }
          dependents.forEach(function (d, i) {
            if (i > 0) { %>, <% }
            %><a href="<%= d.url %>"><%- d.name %></a><%
          })
          %>
          </td>
        </tr>
        <% } %>
        <% if (package.users) { %>
        <tr>
          <th>Starred by:</th>
          <td>
            <%
            var starredBy = package.starredBy
            var l = starredBy.length
            var max = 20
            if (l > max) {
              starredBy = starredBy.sort(function (a, b) {
                return Math.random() * 2 - 1
              }).slice(0, max)
            }
            starredBy.forEach(function (user, i) {
              if (i > 0) { %>, <% }
              %><a href="/profile/<%= user %>"><%= user %></a><%
            })
            if (l > max) {
              %><br><a href="/browse/star/<%= package.name %>">and
              <%= (l-max) %> more</a><%
            }
            %>
          </td>
        </tr>
        <% } %>
      </table>

      <div class="details">
        <ul class="toc">
          <% if (package.readme) { %>
          <li><a href="#readme">Read Me</a></li>
          <% } %>
        </ul>

        <% if (package.readme) { %>
        <section id="readme">
        <%- package.readme %>
        </section>
        <% } %>
      </div>
    </div>
  </div>
</div>
<style>
  span.gitinfo {margin-right: 5px}
</style>
<script src="http://code.jquery.com/jquery.min.js"></script>
<script>
  var github = $('#github').attr('href')
  $.ajax(
    { dataType: 'json'
    , url: github.replace('github.com/', 'api.github.com/repos/')
    , success: function (doc) {
      console.log(doc)
      var h = '<tr><th>GitHub:</th><td>'
      h += '<div class="gitinfo">forks: <a href="'+github+'/network'+'">'+doc.forks+'</a></div>'
      h += '<div class="gitinfo">watchers: <a href="'+github+'/stargazers'+'">'+doc.watchers+'</a></div>'
      h += '<div class="gitinfo">last commit: <a href="'+github+'/commit/master'+'">'+(new Date(doc.pushed_at)).toDateString()+'</a></div>'
      h += '</td></tr>'
      $('#github').parent().parent().after(h)
    }
    , error: function (e) {console.log(e)}
    }
  )
</script>
<%- include('footer.ejs', locals) %>
